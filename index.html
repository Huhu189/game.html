<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advanced Custom Cipher</title>
  <style>
    :root {
      --bg-dark: #0f172a;
      --bg-card: #1e293b;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --accent: #3b82f6;
      --accent-hover: #60a5fa;
      --secondary: #334155;
      --border: #334155;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
    }
    
    body {
      background: var(--bg-dark);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      line-height: 1.5;
      padding: 20px;
      margin: 0;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border);
    }
    
    h1 {
      font-size: 24px;
      margin: 0 0 8px;
      background: linear-gradient(90deg, #60a5fa, #3b82f6);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    
    .subtitle {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    textarea, input {
      width: 100%;
      padding: 12px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: 'Menlo', 'Consolas', monospace;
      font-size: 14px;
      resize: vertical;
      box-sizing: border-box;
    }
    
    textarea { min-height: 120px; }
    
    .btn-group {
      display: flex;
      gap: 12px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-secondary { background: var(--secondary); color: var(--text-primary); }
    .btn-secondary:hover { background: #475569; }
    
    .output-container {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid var(--border);
      margin-top: 8px;
      position: relative;
    }
    
    .output-placeholder { color: var(--text-secondary); font-style: italic; }
    #output { font-family: 'Menlo', 'Consolas', monospace; white-space: pre-wrap; word-break: break-all; }
    
    .status { display: inline-block; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 500; margin-top: 12px; }
    .status-success { background: rgba(16, 185, 129, 0.2); color: var(--success); }
    .status-error { background: rgba(239, 68, 68, 0.2); color: var(--error); }
    
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
    .tab { padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .tab.active { background: rgba(59, 130, 246, 0.2); color: var(--accent); }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .segment { margin-bottom: 16px; }
    .segment-title { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    .segment-content { background: rgba(15, 23, 42, 0.6); border-radius: 8px; padding: 12px; border: 1px solid var(--border); font-family: 'Menlo', 'Consolas', monospace; word-break: break-all; }
    
    .copy-btn { position: absolute; top: 12px; right: 12px; background: rgba(30, 41, 59, 0.8); border: 1px solid var(--border); color: var(--text-secondary); border-radius: 6px; padding: 6px 10px; font-size: 12px; cursor: pointer; transition: all 0.2s; }
    .copy-btn:hover { color: var(--accent); border-color: var(--accent); }
    
    .info-box { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 16px; margin-top: 20px; font-size: 14px; }
    .info-title { display: flex; align-items: center; gap: 8px; color: var(--accent); margin-bottom: 8px; font-weight: 500; }
    .info-content { color: var(--text-secondary); line-height: 1.6; }
    
    .sequence-code { font-family: 'Menlo', 'Consolas', monospace; background: rgba(15, 23, 42, 0.6); padding: 12px; border-radius: 8px; border: 1px solid var(--border); margin-top: 8px; word-break: break-all; }
    
    .emoji-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 12px; margin-top: 16px; }
    .emoji-item { font-size: 24px; text-align: center; padding: 8px; background: rgba(15, 23, 42, 0.6); border-radius: 8px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s; }
    .emoji-item:hover { transform: scale(1.1); background: rgba(59, 130, 246, 0.2); }
    
    @media (max-width: 768px) {
      .container { padding: 10px; }
      .card { padding: 16px; }
      .btn-group { flex-direction: column; }
      .btn { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Advanced Custom Cipher</h1>
      <p class="subtitle">Enkripsi dengan Sequence Code terpisah untuk keamanan ekstra</p>
      
      <div class="form-group">
        <label for="inputText">Teks Input (Plaintext/Ciphertext)</label>
        <textarea id="inputText" placeholder="Masukkan teks yang ingin dienkripsi atau didekripsi..."></textarea>
      </div>
      
      <div class="form-group">
        <label for="keyInput">Kunci Rahasia</label>
        <input type="text" id="keyInput" placeholder="Masukkan kunci enkripsi/dekripsi...">
      </div>
      
      <div class="btn-group">
        <button id="encryptBtn" class="btn btn-primary">Enkripsi</button>
        <button id="decryptBtn" class="btn btn-secondary">Dekripsi</button>
        <button id="resetBtn" class="btn btn-secondary">Reset</button>
      </div>
      
      <div class="form-group">
        <label>Output Enkripsi</label>
        <div class="output-container">
          <div id="output" class="output-placeholder">Hasil enkripsi akan muncul di sini...</div>
          <button class="copy-btn" id="copyOutputBtn">Salin</button>
        </div>
        
        <label style="margin-top: 16px;">Sequence Code (boleh ketik / paste)</label>
        <!-- GANTI: sequenceCodeOutput sekarang input yang dapat diketik & dipaste -->
        <input type="text" id="sequenceCodeOutput" class="sequence-code" placeholder="Sequence code akan muncul di sini atau masukkan sequence code untuk dekripsi...">
        
        <div id="outputStatus" class="status"></div>
      </div>
      
      <div class="tabs">
        <div class="tab active" data-tab="segments">Struktur Output</div>
        <div class="tab" data-tab="library">Library Simbol</div>
        <div class="tab" data-tab="translator">Sequence Translator</div>
      </div>
      
      <div class="tab-content active" id="segmentsContent">
        <div class="segment">
          <div class="segment-title">Header</div>
          <div class="segment-content" id="headerSegment">-</div>
        </div>
        
        <div class="segment">
          <div class="segment-title">Ciphertext</div>
          <div class="segment-content" id="ciphertextSegment">-</div>
        </div>
      </div>
      
      <div class="tab-content" id="libraryContent">
        <p class="subtitle">Koleksi simbol dan emoji yang digunakan dalam enkripsi</p>
        <div class="emoji-grid" id="emojiGrid"></div>
      </div>
      
      <div class="tab-content" id="translatorContent">
        <div class="form-group">
          <label for="sequenceInput">Sequence Code (alternatif)</label>
          <input type="text" id="sequenceInput" placeholder="Masukkan sequence code untuk diterjemahkan...">
        </div>
        
        <div class="btn-group">
          <button id="translateBtn" class="btn btn-primary">Terjemahkan</button>
          <button id="copySequenceBtn" class="btn btn-secondary">Salin Sequence</button>
        </div>
        
        <div class="form-group">
          <label>Hasil Terjemahan</label>
          <div class="output-container">
            <div id="translationResult" class="output-placeholder">Hasil terjemahan akan muncul di sini...</div>
          </div>
        </div>
      </div>
      
      <div class="info-box">
        <div class="info-title">Petunjuk Penggunaan</div>
        <div class="info-content">
          <p><strong>Enkripsi:</strong> Masukkan teks dan kunci, lalu klik Enkripsi. Hasil ciphertext akan muncul pada kolom Output dan Sequence Code akan ter-generate di field Sequence Code di atas (bisa disalin atau diketik manual).</p>
          <p><strong>Dekripsi:</strong> Masukkan ciphertext pada field Teks Input, masukkan kunci, masukkan atau paste Sequence Code pada field Sequence Code (yang bisa diketik), lalu klik Dekripsi.</p>
          <p><strong>Sequence Translator:</strong> Gunakan tab Translator untuk menganalisa komponen sequence code jika perlu.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- Utilities ---
      function utf32Encode(str) {
        const codes = [];
        for (let ch of str) codes.push(ch.codePointAt(0) >>> 0);
        return codes;
      }
      function utf32Decode(arr) {
        return arr.map(c => String.fromCodePoint(c)).join('');
      }
      function seedFromString(s) {
        let h = 2166136261 >>> 0;
        for (let i = 0; i < s.length; i++) h = Math.imul(h ^ s.charCodeAt(i), 16777619) >>> 0;
        return h >>> 0;
      }
      function makePRNG(seed) {
        let t = seed >>> 0;
        return function() {
          t += 0x6D2B79F5;
          let r = Math.imul(t ^ (t >>> 15), t | 1);
          r ^= r + Math.imul(r ^ (r >>> 7), r | 61);
          return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
        };
      }
      function keyToBytes(k) {
        const out = [];
        for (let i = 0; i < k.length; i++) out.push(k.charCodeAt(i) & 0xFF);
        if (out.length === 0) out.push(0);
        return out;
      }
      function xorArrayWithKey(arr, keyBytes) {
        const out = [];
        for (let i = 0; i < arr.length; i++) {
          const kb = keyBytes[i % keyBytes.length];
          const kb32 = (kb | (kb << 8) | (kb << 16) | (kb << 24)) >>> 0;
          out.push((arr[i] ^ kb32) >>> 0);
        }
        return out;
      }

      // --- base64 <-> utf8 safe helpers (fix btoa/atob issues with emojis/utf8) ---
      function base64EncodeUtf8(str) {
        const bytes = new TextEncoder().encode(str);
        let binary = '';
        for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
        return btoa(binary);
      }
      function base64DecodeUtf8(b64) {
        const binary = atob(b64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
        return new TextDecoder().decode(bytes);
      }

      // --- Extended Symbol Tables (700+ symbols and emojis) ---
      const tables = (function() {
        const numbers = [..."0123456789"];
        const lettersLower = [];
        for (let c = 97; c <= 122; c++) lettersLower.push(String.fromCharCode(c));
        const lettersUpper = lettersLower.map(l => l.toUpperCase());
        const letters = lettersLower.concat(lettersUpper);
        
        const symbols = [];
        for (let c = 33; c <= 47; c++) symbols.push(String.fromCharCode(c));
        for (let c = 58; c <= 64; c++) symbols.push(String.fromCharCode(c));
        for (let c = 91; c <= 96; c++) symbols.push(String.fromCharCode(c));
        for (let c = 123; c <= 126; c++) symbols.push(String.fromCharCode(c));
        for (let c = 8704; c <= 8959; c++) {
          try { symbols.push(String.fromCharCode(c)); } catch(e) {}
        }
        
        const emojis = [
          'ðŸ˜€','ðŸ˜ƒ','ðŸ˜„','ðŸ˜','ðŸ˜†','ðŸ˜…','ðŸ˜‚','ðŸ¤£','ðŸ˜Š','ðŸ˜‡','ðŸ™‚','ðŸ™ƒ','ðŸ˜‰','ðŸ˜Œ','ðŸ˜','ðŸ¥°','ðŸ˜˜','ðŸ˜—','ðŸ˜™','ðŸ˜š',
          'ðŸ˜‹','ðŸ˜›','ðŸ˜','ðŸ˜œ','ðŸ¤ª','ðŸ¤¨','ðŸ§','ðŸ¤“','ðŸ˜Ž','ðŸ¤©','ðŸ¥³','ðŸ˜','ðŸ˜’','ðŸ˜ž','ðŸ˜”','ðŸ˜Ÿ','ðŸ˜•','ðŸ™','â˜¹ï¸','ðŸ˜£',
          'ðŸ˜–','ðŸ˜«','ðŸ˜©','ðŸ¥º','ðŸ˜¢','ðŸ˜­','ðŸ˜¤','ðŸ˜ ','ðŸ˜¡','ðŸ¤¬','ðŸ¤¯','ðŸ˜³','ðŸ¥µ','ðŸ¥¶','ðŸ˜±','ðŸ˜¨','ðŸ˜°','ðŸ˜¥','ðŸ˜“','ðŸ¤—',
          'ðŸ¤”','ðŸ¤­','ðŸ¤«','ðŸ¤¥','ðŸ˜¶','ðŸ˜','ðŸ˜‘','ðŸ˜¬','ðŸ™„','ðŸ˜¯','ðŸ˜¦','ðŸ˜§','ðŸ˜®','ðŸ˜²','ðŸ¥±','ðŸ˜´','ðŸ¤¤','ðŸ˜ª','ðŸ˜µ','ðŸ¤',
          'ðŸ¥´','ðŸ¤¢','ðŸ¤®','ðŸ¤§','ðŸ˜·','ðŸ¤’','ðŸ¤•','ðŸ¤‘','ðŸ¤ ','ðŸ˜ˆ','ðŸ‘¿','ðŸ‘¹','ðŸ‘º','ðŸ¤¡','ðŸ’©','ðŸ‘»','ðŸ’€','â˜ ï¸','ðŸ‘½','ðŸ‘¾',
          'ðŸ¤–','ðŸŽƒ','ðŸ˜º','ðŸ˜¸','ðŸ˜¹','ðŸ˜»','ðŸ˜¼','ðŸ˜½','ðŸ™€','ðŸ˜¿','ðŸ˜¾','ðŸ‘‹','ðŸ¤š','ðŸ–','âœ‹','ðŸ––','ðŸ‘Œ','ðŸ¤','âœŒï¸','ðŸ¤ž',
          'ðŸ¤Ÿ','ðŸ¤˜','ðŸ¤™','ðŸ‘ˆ','ðŸ‘‰','ðŸ‘†','ðŸ–•','ðŸ‘‡','â˜ï¸','ðŸ‘','ðŸ‘Ž','âœŠ','ðŸ‘Š','ðŸ¤›','ðŸ¤œ','ðŸ‘','ðŸ™Œ','ðŸ‘','ðŸ¤²','ðŸ¤',
          'ðŸ™','âœï¸','ðŸ’…','ðŸ¤³','ðŸ’ª','ðŸ¦¾','ðŸ¦¿','ðŸ¦µ','ðŸ¦¶','ðŸ‘‚','ðŸ¦»','ðŸ‘ƒ','ðŸ§ ','ðŸ¦·','ðŸ¦´','ðŸ‘€','ðŸ‘','ðŸ‘…','ðŸ‘„',
          'ðŸ«¦','ðŸ‘¶','ðŸ§’','ðŸ‘¦','ðŸ‘§','ðŸ§‘','ðŸ‘±','ðŸ‘¨','ðŸ§”','ðŸ§”â€â™‚ï¸','ðŸ§”â€â™€ï¸','ðŸ‘¨â€ðŸ¦°','ðŸ‘¨â€ðŸ¦±','ðŸ‘¨â€ðŸ¦³','ðŸ‘¨â€ðŸ¦²','ðŸ‘©','ðŸ‘©â€ðŸ¦°','ðŸ‘©â€ðŸ¦±','ðŸ‘©â€ðŸ¦³','ðŸ‘©â€ðŸ¦²',
          'ðŸ§“','ðŸ‘´','ðŸ‘µ','ðŸ™','ðŸ™â€â™‚ï¸','ðŸ™â€â™€ï¸','ðŸ™Ž','ðŸ™Žâ€â™‚ï¸','ðŸ™Žâ€â™€ï¸','ðŸ™…','ðŸ™…â€â™‚ï¸','ðŸ™…â€â™€ï¸','ðŸ™†','ðŸ™†â€â™‚ï¸','ðŸ™†â€â™€ï¸','ðŸ’','ðŸ’â€â™‚ï¸','ðŸ’â€â™€ï¸','ðŸ™‹','ðŸ™‹â€â™‚ï¸',
          'ðŸ™‹â€â™€ï¸','ðŸ§','ðŸ§â€â™‚ï¸','ðŸ§â€â™€ï¸','ðŸ™‡','ðŸ™‡â€â™‚ï¸','ðŸ™‡â€â™€ï¸','ðŸ¤¦','ðŸ¤¦â€â™‚ï¸','ðŸ¤¦â€â™€ï¸','ðŸ¤·','ðŸ¤·â€â™‚ï¸','ðŸ¤·â€â™€ï¸','ðŸ‘¨â€âš•ï¸','ðŸ‘©â€âš•ï¸','ðŸ‘¨â€ðŸŽ“','ðŸ‘©â€ðŸŽ“','ðŸ‘¨â€ðŸ«','ðŸ‘©â€ðŸ«','ðŸ‘¨â€âš–ï¸',
          'ðŸ‘©â€âš–ï¸','ðŸ‘¨â€ðŸŒ¾','ðŸ‘©â€ðŸŒ¾','ðŸ‘¨â€ðŸ³','ðŸ‘©â€ðŸ³','ðŸ‘¨â€ðŸ”§','ðŸ‘©â€ðŸ”§','ðŸ‘¨â€ðŸ­','ðŸ‘©â€ðŸ­','ðŸ‘¨â€ðŸ’¼','ðŸ‘©â€ðŸ’¼','ðŸ‘¨â€ðŸ”¬','ðŸ‘©â€ðŸ”¬','ðŸ‘¨â€ðŸ’»','ðŸ‘©â€ðŸ’»','ðŸ‘¨â€ðŸŽ¤','ðŸ‘©â€ðŸŽ¤','ðŸ‘¨â€ðŸŽ¨','ðŸ‘©â€ðŸŽ¨','ðŸ‘¨â€âœˆï¸',
          'ðŸ‘©â€âœˆï¸','ðŸ‘¨â€ðŸš€','ðŸ‘©â€ðŸš€','ðŸ‘¨â€ðŸš’','ðŸ‘©â€ðŸš’','ðŸ‘®','ðŸ‘®â€â™‚ï¸','ðŸ‘®â€â™€ï¸','ðŸ•µï¸','ðŸ•µï¸â€â™‚ï¸','ðŸ•µï¸â€â™€ï¸','ðŸ’‚','ðŸ’‚â€â™‚ï¸','ðŸ’‚â€â™€ï¸','ðŸ¥·','ðŸ‘·','ðŸ‘·â€â™‚ï¸','ðŸ‘·â€â™€ï¸','ðŸ¤´'
        ];
        
        const allSymbols = [...symbols, ...emojis];
        let cpAppend = 0x2000;
        while(allSymbols.length < 700) allSymbols.push(String.fromCodePoint(cpAppend++));
        return {numbers, lettersLower, lettersUpper, letters, symbols: allSymbols};
      })();

      // --- Encryption / Decryption (preserve original logic with fixes) ---
      function encryptWithSequence(plaintext, key) {
        try {
          const seed = Math.floor(Math.random() * 1000000000);
          const prng = makePRNG(seed);
          const keyBytes = keyToBytes(key);
          const codes = utf32Encode(plaintext);
          
          let indices = codes.map(c => {
            if (c >= 48 && c <= 57) return c - 48;
            if (c >= 97 && c <= 122) return (c - 97) + 10;
            if (c >= 65 && c <= 90) return (c - 65) + 36;
            return (c % 700) + 62;
          });
          
          const augmented = [];
          for (let i = 0; i < codes.length; i++) {
            const cp = codes[i];
            const idx = indices[i];
            augmented.push(idx);
            if ((cp >= 97 && cp <= 122) || (cp >= 65 && cp <= 90)) {
              const symIdx = idx % tables.symbols.length;
              augmented.push(100000 + symIdx);
            }
          }
          
          const expanded = [];
          for (let v of augmented) {
            if (v >= 100000) {
              const baseSym = (v - 100000) % tables.symbols.length;
              expanded.push(200000 + baseSym);
              for (let k = 0; k < 5; k++) {
                const r = Math.floor(prng() * tables.symbols.length);
                expanded.push(200000 + ((baseSym + r + k) % tables.symbols.length));
              }
            } else {
              expanded.push(v);
            }
          }
          
          const x = xorArrayWithKey(expanded.map(v => v >>> 0), keyBytes);
          const payload = { v: x, s: seed % 1000000 };
          const ciphertext = base64EncodeUtf8(JSON.stringify(payload));
          
          // Sequence code generation (same logic)
          const sequenceParts = [];
          const timestamp = Date.now().toString(36);
          sequenceParts.push(timestamp.slice(0, 4));
          for (let i = 0; i < 2; i++) {
            const emojiIndex = Math.floor(prng() * tables.symbols.length);
            sequenceParts.push(tables.symbols[emojiIndex]);
          }
          const alphanumeric = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
          for (let i = 0; i < 4; i++) {
            const idx = Math.floor(prng() * alphanumeric.length);
            sequenceParts.push(alphanumeric.charAt(idx));
          }
          const symbols = '!@#$%^&*-_+=';
          for (let i = 0; i < 2; i++) {
            const idx = Math.floor(prng() * symbols.length);
            sequenceParts.push(symbols.charAt(idx));
          }
          const shuffled = sequenceParts.sort(() => 0.5 - prng());
          const sequenceCode = shuffled.join('');
          
          const symbolSequence = [];
          for (let i = 0; i < 6; i++) {
            const idx = Math.floor(prng() * tables.symbols.length);
            symbolSequence.push(tables.symbols[idx]);
          }
          const sequenceData = {
            version: 'v2',
            symbols: symbolSequence,
            timestamp: Date.now(),
            ciphertextHash: hashCode(ciphertext)
          };
          const encodedSequence = base64EncodeUtf8(JSON.stringify(sequenceData));
          
          return { ciphertext, sequenceCode, encodedSequence, symbolSequence: symbolSequence.join('') };
        } catch (error) {
          throw new Error('Encryption failed: ' + error.message);
        }
      }

      function decryptWithSequence(ciphertext, sequenceCode, key) {
        try {
          const jsonStr = base64DecodeUtf8(ciphertext);
          const payload = JSON.parse(jsonStr);
          const keyBytes = keyToBytes(key);
          const xored = (payload.v || []).map(n => n >>> 0);
          const unx = xorArrayWithKey(xored, keyBytes);
          
          const reduced = [];
          for (let i = 0; i < unx.length;) {
            const val = unx[i];
            if (val >= 200000) {
              const baseSym = (val - 200000) % tables.symbols.length;
              reduced.push(100000 + baseSym);
              i += 6;
            } else {
              reduced.push(val);
              i++;
            }
          }
          
          const originalIndices = [];
          for (let v of reduced) {
            if (v < 100000) originalIndices.push(v);
          }
          
          const codes = originalIndices.map(idx => {
            if (idx < 10) return '0'.codePointAt(0) + idx;
            if (idx < 36) return 97 + (idx - 10);
            if (idx < 62) return 65 + (idx - 36);
            const symIdx = (idx - 62) % tables.symbols.length;
            return tables.symbols[symIdx].codePointAt(0);
          });
          
          return utf32Decode(codes);
        } catch (error) {
          throw new Error('Decryption failed: ' + error.message);
        }
      }

      function hashCode(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash;
        }
        return hash.toString(16);
      }

      // --- UI Elements ---
      const inputEl = document.getElementById('inputText');
      const keyEl = document.getElementById('keyInput');
      const outputEl = document.getElementById('output');
      const sequenceCodeOutput = document.getElementById('sequenceCodeOutput'); // now input
      const outputStatus = document.getElementById('outputStatus');
      const copyOutputBtn = document.getElementById('copyOutputBtn');
      const encryptBtn = document.getElementById('encryptBtn');
      const decryptBtn = document.getElementById('decryptBtn');
      const resetBtn = document.getElementById('resetBtn');
      const headerSegment = document.getElementById('headerSegment');
      const ciphertextSegment = document.getElementById('ciphertextSegment');
      const sequenceInput = document.getElementById('sequenceInput');
      const translateBtn = document.getElementById('translateBtn');
      const copySequenceBtn = document.getElementById('copySequenceBtn');
      const translationResult = document.getElementById('translationResult');
      const emojiGrid = document.getElementById('emojiGrid');
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');

      // Populate emoji grid
      tables.symbols.slice(0, 300).forEach(symbol => {
        const emojiItem = document.createElement('div');
        emojiItem.className = 'emoji-item';
        emojiItem.textContent = symbol;
        emojiGrid.appendChild(emojiItem);
      });

      // Tab switching
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          const tabId = tab.dataset.tab + 'Content';
          document.getElementById(tabId).classList.add('active');
        });
      });

      // ENCRYPT
      encryptBtn.addEventListener('click', () => {
        const text = inputEl.value;
        const key = keyEl.value;
        if (!text || text.trim().length === 0) { showStatus('Masukkan teks yang ingin dienkripsi', 'error'); return; }
        if (!key || key.trim().length === 0) { showStatus('Masukkan kunci rahasia', 'error'); return; }

        try {
          const { ciphertext, sequenceCode } = encryptWithSequence(text, key);
          outputEl.textContent = ciphertext;
          outputEl.classList.remove('output-placeholder');
          // set sequence code into editable input so user bisa ketik/paste/ubah
          sequenceCodeOutput.value = sequenceCode;
          headerSegment.textContent = `v2 | ${new Date().toISOString().slice(0,10)}`;
          ciphertextSegment.textContent = ciphertext.substring(0, 80) + (ciphertext.length > 80 ? '...' : '');
          showStatus('Enkripsi berhasil! Simpan ciphertext dan sequence code dengan aman.', 'success');
        } catch (err) {
          showStatus(`Error: ${err.message}`, 'error');
        }
      });

      // DECRYPT
      decryptBtn.addEventListener('click', () => {
        const ciphertext = inputEl.value.trim();
        const sequenceCode = sequenceCodeOutput.value && sequenceCodeOutput.value.trim() !== '' ? sequenceCodeOutput.value.trim() : sequenceInput.value.trim();
        const key = keyEl.value.trim();

        if (!ciphertext) { showStatus('Masukkan ciphertext yang ingin didekripsi', 'error'); return; }
        if (!sequenceCode) { showStatus('Sequence code diperlukan untuk dekripsi', 'error'); return; }
        if (!key) { showStatus('Masukkan kunci rahasia', 'error'); return; }

        try {
          const decrypted = decryptWithSequence(ciphertext, sequenceCode, key);
          outputEl.textContent = decrypted;
          outputEl.classList.remove('output-placeholder');
          showStatus('Dekripsi berhasil!', 'success');
        } catch (err) {
          showStatus(`Error: ${err.message}`, 'error');
        }
      });

      // TRANSLATE sequence (ke tab translator)
      translateBtn.addEventListener('click', () => {
        const sequence = sequenceInput.value.trim();
        if (!sequence) { translationResult.textContent = 'Masukkan sequence code terlebih dahulu'; translationResult.classList.remove('output-placeholder'); return; }
        try {
          const components = [];
          let currentType = '', currentComponent = '';
          for (const char of sequence) {
            if (char.codePointAt(0) > 255) {
              if (currentType !== 'emoji') { if (currentComponent) components.push({ type: currentType, value: currentComponent }); currentType = 'emoji'; currentComponent = char; }
              else currentComponent += char;
            } else if (/[a-zA-Z]/.test(char)) {
              if (currentType !== 'letter') { if (currentComponent) components.push({ type: currentType, value: currentComponent }); currentType = 'letter'; currentComponent = char; }
              else currentComponent += char;
            } else if (/\d/.test(char)) {
              if (currentType !== 'number') { if (currentComponent) components.push({ type: currentType, value: currentComponent }); currentType = 'number'; currentComponent = char; }
              else currentComponent += char;
            } else {
              if (currentType !== 'symbol') { if (currentComponent) components.push({ type: currentType, value: currentComponent }); currentType = 'symbol'; currentComponent = char; }
              else currentComponent += char;
            }
          }
          if (currentComponent) components.push({ type: currentType, value: currentComponent });

          let result = 'Komponen Sequence Code:\n\n';
          components.forEach(comp => result += `â€¢ ${comp.type.toUpperCase()}: ${comp.value}\n`);
          result += '\nInformasi tambahan:\n';
          result += `- Panjang: ${sequence.length} karakter\n`;
          result += `- Hash: ${hashCode(sequence)}\n`;
          translationResult.textContent = result;
          translationResult.classList.remove('output-placeholder');
        } catch (err) {
          translationResult.textContent = `Error: ${err.message}`; translationResult.classList.remove('output-placeholder');
        }
      });

      // COPY output
      copyOutputBtn.addEventListener('click', () => {
        if (outputEl.classList.contains('output-placeholder')) return;
        navigator.clipboard.writeText(outputEl.textContent)
          .then(() => { const orig = copyOutputBtn.innerHTML; copyOutputBtn.innerHTML = 'Tersalin!'; setTimeout(()=>copyOutputBtn.innerHTML = orig, 1600); })
          .catch(e => console.error('Copy failed', e));
      });

      // COPY sequence (dari input editable)
      copySequenceBtn.addEventListener('click', () => {
        const seq = sequenceCodeOutput.value && sequenceCodeOutput.value.trim() !== '' ? sequenceCodeOutput.value.trim() : sequenceInput.value.trim();
        if (!seq) return;
        navigator.clipboard.writeText(seq)
          .then(() => { const orig = copySequenceBtn.innerHTML; copySequenceBtn.innerHTML = 'Tersalin!'; setTimeout(()=>copySequenceBtn.innerHTML = orig, 1600); })
          .catch(e => console.error('Copy failed', e));
      });

      // RESET
      resetBtn.addEventListener('click', () => {
        inputEl.value = '';
        keyEl.value = '';
        outputEl.textContent = 'Hasil enkripsi akan muncul di sini...';
        outputEl.classList.add('output-placeholder');
        sequenceCodeOutput.value = '';
        sequenceInput.value = '';
        outputStatus.textContent = '';
        outputStatus.className = 'status';
        headerSegment.textContent = '-';
        ciphertextSegment.textContent = '-';
        translationResult.textContent = 'Hasil terjemahan akan muncul di sini...';
        translationResult.classList.add('output-placeholder');
      });

      // helper show status
      function showStatus(message, type) {
        outputStatus.textContent = message;
        outputStatus.className = 'status';
        outputStatus.classList.add(`status-${type}`);
      }

      // small UX: let user paste into sequenceCodeOutput using right-click / ctrl-v (default allowed)
      // ensure focus styling isn't disabled by CSS (we used normal input so it's fine)
    });
  </script>
</body>
</html>
